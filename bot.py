import os
import random

import discord
from discord.ext import commands
from discord import app_commands
from dotenv import load_dotenv
import pandas as pd
from discord.ext.commands import has_permissions, CheckFailure
# CONFIG 

load_dotenv()
DISCORD_TOKEN = os.getenv('DISCORD_TOKEN')
GUILD_ID = int(os.getenv("GUILD_ID"))

intents = discord.Intents.default()
intents.message_content = True

# Emoji 
def random_cat():
    return random.choice([
        "<:cat3:1389433164987891712>",
        "<:cat4:1389433163868274719>",
        "<:cat5:1389433162685218878>",
        "<:cat6:1389433161632579664>",
        "<:cat7:1389433160382550186>",
        "<:cat8:1389433158436519967>",
        "<:cat9:1389433155915616256>",
        "<:cat10:1389433165940265021>"
    ])

spycat_X = "<:spycat_X:1390091541472612482>"
spycat_good = "<:spycat_good:1390091537219584112>"
spycat_hint = "<:spycat_hint:1390091535336603728>"
spycat_roulette = "<:spycat_roulette:1390091539270598728>"
spycat_roulette_hit = "<:spycat_roulette_hit:1390091533457293322>"
spycat_roulette_miss = "<:spycat_roulette_miss:1390091530861023363>"
spycat_stop = "<:spycat_stop:1390091528717991946>"

# UTILS 

def check_flag_in_csv(flag: str):
    df = pd.read_csv('valid_flags.csv')
    row = df[df['Flag'] == flag]
    if not row.empty:
        points = int(row['Points'].values[0])
        return True, points
    else:
        return False, 0



def update_scoreboard(user: str, flag: str, points: int) -> bool:
    df = pd.read_csv('scoreboard.csv')

    if user not in df['Team'].values:
        new_row = pd.DataFrame([{
            'Team': user,
            'Points': points,
            'Submitted_Flags': flag
        }])
        df = pd.concat([df, new_row], ignore_index=True)
    else:
        idx = df.index[df['Team'] == user][0]
        submitted_flags = str(df.at[idx, 'Submitted_Flags'])
        if pd.isna(submitted_flags) or submitted_flags == 'nan':
            submitted_flags = ""

        flags = [f.strip() for f in submitted_flags.split(';') if f.strip()]
        if flag in flags:
            return False  
        df.at[idx, 'Points'] += points
        flags.append(flag)
        df.at[idx, 'Submitted_Flags'] = ';'.join(flags)

    df.to_csv('scoreboard.csv', index=False)
    return True


# BOT

class SpyCatBot(commands.Bot):
    def __init__(self):

        super().__init__(command_prefix="/", intents=intents)
        self.synced = False

    async def setup_hook(self):

        for g in self.guilds:
            try:
                self.tree.copy_global_to(guild=discord.Object(id=g.id))
                await self.tree.sync(guild=discord.Object(id=g.id))
                print(f"[SPY_CAT] Slash commands sync -> {g.name} ({g.id})")
            except Exception as e:
                print(f"[SPY_CAT] Sync failed for {g.id}: {e}")

        try:
            await self.tree.sync()
            print("[SPY_CAT] Global commands synced (may take time to propagate).")
        except Exception as e:
            print(f"[SPY_CAT] Global sync failed: {e}")

bot = SpyCatBot()

@bot.event
async def on_guild_join(guild: discord.Guild):
    """Quand le bot rejoint un nouveau serveur, pousse imm√©diatement les slash commands dedans."""
    try:
        bot.tree.copy_global_to(guild=discord.Object(id=guild.id))
        await bot.tree.sync(guild=discord.Object(id=guild.id))
        print(f"[SPY_CAT] Joined {guild.name} -> commands synced.")
    except Exception as e:
        print(f"[SPY_CAT] Sync on join failed for {guild.id}: {e}")




@bot.event
async def on_message(message):
    if message.author == bot.user:
        return

    if "CSIUL{" in message.content:
        try:
            await message.delete()
        except discord.Forbidden:
            print("[SPY_CAT] Permission refus√©e pour supprimer un message.")

        try:
            await message.channel.send(
                f"{spycat_stop} Chhht agent {message.author.mention} ! "
                f"SpyCat a intercept√© ton flag `{message.content.strip()[:30]}...` "
                f"et l‚Äôa r√©duit en cendres. "
                f"Les secrets ne miaulent pas en plein jour. {spycat_X}",
                delete_after=5
            )
        except discord.Forbidden:
            print("[SPY_CAT] Impossible d'envoyer une alerte.")

    await bot.process_commands(message)


# EVENTS

@bot.event
async def on_ready():
    print(f'[SPY_CAT] Bot connect√© en tant que {bot.user}')


# COMMANDS

## SCOREBOARD 
@bot.tree.command(name="scoreboard", description="Affiche le classement des agents.")
async def scoreboard(interaction: discord.Interaction):
    df = pd.read_csv('scoreboard.csv')
    df = df.sort_values(by='Points', ascending=False).reset_index(drop=True)

    msg = f"**{spycat_good} SPYCAT SCOREBOARD {spycat_good}**\n```"

    for index, row in df.iterrows():
        rank = index + 1
        team = row['Team']
        points = row['Points']
        medal = "ü•á" if rank == 1 else "ü•à" if rank == 2 else "ü•â" if rank == 3 else f"{rank}."
        msg += f"{medal} {team.ljust(15)} {str(points).rjust(5)} pts\n"

    msg += "```"

    await interaction.response.send_message(msg)



## WHOAMI 
@bot.tree.command(name="whoami", description="Affiche tes points actuels.")
async def whoami(interaction: discord.Interaction):
    df = pd.read_csv('scoreboard.csv')
    user = interaction.user.name

    if user in df['Team'].values:
        idx = df.index[df['Team'] == user][0]
        points = df.at[idx, 'Points']
        submitted = df.at[idx, 'Submitted_Flags']
        submitted = submitted if pd.notna(submitted) else "Aucun flag soumis"
    else:
        points = 0
        submitted = "Aucun flag soumis"

    await interaction.response.send_message(
        f"üêæ Agent {user} : {points} pts. Flags trouv√©s : {submitted} {random_cat()}"
    )


## STATS
@bot.tree.command(name="stats", description="Stats globales des agents.")
async def stats(interaction: discord.Interaction):
    df = pd.read_csv('scoreboard.csv')
    nb_teams = len(df)
    total_points = df['Points'].sum()
    await interaction.response.send_message(
        f"{spycat_hint} **Statistiques du R√©seau SpyCat** {spycat_hint}\n"
        f"üë• Agents actifs : **{nb_teams}**\n"
        f"üí∞ Total de points vol√©s : **{total_points}**\n"
        f"{spycat_good} Continue de traquer, espion !"
    )


## CAT 
@bot.tree.command(name="cat", description="Miaou al√©atoire pour l'ambiance.")
async def cat(interaction: discord.Interaction):
    await interaction.response.send_message(f"{random_cat()} Miaou ~ {random_cat()}")


## SUBMIT
@bot.tree.command(name="submit", description="Soumets ton flag √† ta planque secr√®te.")
@app_commands.describe(flag="Ton flag √† soumettre")
async def submit(interaction: discord.Interaction, flag: str):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()

    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name == channel_name:
        is_valid, points = check_flag_in_csv(flag)

        if is_valid:
            added = update_scoreboard(user.name, flag, points)
            if added:
                result_msg = (
                    f"{spycat_good} Bien jou√© agent **{user.name}** !\n"
                    f"Ton flag est **correct** (+{points} pts) !"
                )
            else:
                result_msg = (
                    f"{spycat_stop} Agent **{user.name}**, ce flag est correct "
                    f"mais d√©j√† soumis ! Aucun point ajout√©."
                )
        else:
            result_msg = (
                f"{spycat_X} D√©sol√© agent **{user.name}**, "
                f"ce flag est **incorrect** ! Essaie encore !"
            )

        await interaction.response.send_message(
            f"üîë Flag soumis : `{flag}`\n{result_msg}"
        )
    else:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")

        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"üì¨ Flag re√ßu : `{flag}` Bien planqu√© ici.\n"
            f"{spycat_stop} Pour v√©rifier, soumets-le √† nouveau **dans cette planque** !"
        )
        await interaction.response.send_message(
            f"üì¨ Flag re√ßu ! V√©rifie ta planque secr√®te : {planque.mention} {spycat_stop}",
            ephemeral=True
        )


## HELP
@bot.tree.command(name="help", description="Affiche le manuel de l'espion SPY_CAT.")
async def help_command(interaction: discord.Interaction):
    help_msg = f"""
**üìñ GUIDE DE L'AGENT SPY_CAT {spycat_hint}**

Voici tes outils, espion üêæ :

{spycat_hint} **/scoreboard**
   Classement complet des espions et points vol√©s.

{spycat_hint} **/whoami**
   V√©rifie combien de points tu as vol√© toi-m√™me.

{spycat_hint} **/stats**
   Stats globales pour tous les agents sous couverture.

{spycat_hint} **/challenge**
   Re√ßois ton flag de d√©part, encod√© en base64.

{spycat_hint} **/cat**
   Un miaulement al√©atoire pour l‚Äôambiance d‚Äôespionnage.

{spycat_stop} Les flags hors planque sont intercept√©s et d√©truits sur-le-champ.
Reste dans l‚Äôombre, agent. Miaou ! {spycat_X}
"""
    await interaction.response.send_message(help_msg)



# LEGACY COMMANDS

@bot.command(name='delete_category')
@has_permissions(administrator=True)
async def delete_category(ctx, *, category_name: str):
    """Supprime une cat√©gorie CTF et tous ses salons (admin seulement)"""
    category = discord.utils.get(ctx.guild.categories, name=category_name)
    if not category:
        await ctx.send(
            f"{spycat_X} Cat√©gorie introuvable : **{category_name}**",
            delete_after=5
        )
        return

    for channel in category.channels:
        await channel.delete()
    await category.delete()
    await ctx.send(
        f"{spycat_good} Cat√©gorie **{category_name}** et ses salons ont √©t√© supprim√©s.",
        delete_after=5
    )



@delete_category.error
async def delete_category_error(ctx, error):
    if isinstance(error, CheckFailure):
        await ctx.send(
            f"{spycat_stop} Chhht ! Tu n‚Äôas pas la permission d‚Äôutiliser cette commande. *(Admin seulement)*",
            delete_after=5
        )

        
## SOLVED
@bot.tree.command(name="solved", description="Marque ce challenge comme r√©solu (Forum ou Thread).")
async def solved(interaction: discord.Interaction):
    thread = interaction.channel

    if not isinstance(thread, discord.Thread):
        await interaction.response.send_message(
            f"{spycat_stop} Cette commande doit √™tre utilis√©e dans un **thread** !",
            ephemeral=True
        )
        return

    parent = thread.parent

    if isinstance(parent, discord.ForumChannel):
        solved_tag = discord.utils.get(parent.available_tags, name="‚úÖ Solved")
        unsolved_tag = discord.utils.get(parent.available_tags, name="‚ùå Unsolved")

        tags = [tag for tag in thread.applied_tags if tag.name != "‚ùå Unsolved"]

        if solved_tag and solved_tag not in tags:
            tags.append(solved_tag)

        new_name = thread.name
        if not new_name.startswith("‚úÖ "):
            new_name = f"‚úÖ {new_name.lstrip('‚ùå ').strip()}"

        await thread.edit(applied_tags=tags, name=new_name)

        await interaction.response.send_message(
            f"{spycat_good} Challenge marqu√© comme **R√©solu** (Forum) : `{new_name}`",
            ephemeral=False
        )

    else:
        if not thread.name.startswith("‚úÖ "):
            new_name = f"‚úÖ {thread.name.lstrip('‚ùå ').strip()}"
            await thread.edit(name=new_name)
            await interaction.response.send_message(
                f"{spycat_good} Challenge marqu√© comme **R√©solu** : `{new_name}`",
                ephemeral=False
            )
        else:
            await interaction.response.send_message(
                f"{spycat_stop} Ce challenge est d√©j√† marqu√© comme **R√©solu**.",
                ephemeral=True
            )





@bot.tree.command(name="letsfuckingo", description="Marque ce challenge comme r√©solu et renomme le thread.")
async def letsfuckingo(interaction: discord.Interaction):
    thread = interaction.channel

    if not isinstance(thread, discord.Thread):
        await interaction.response.send_message(
            f"{spycat_stop} Pas ici, agent ! Cette commande s‚Äôutilise dans un **thread** ‚Äî SpyCat ne veut pas voir √ßa ailleurs.",
            ephemeral=True
        )
        return

    parent = thread.parent

    if isinstance(parent, discord.ForumChannel):
        solved_tag = discord.utils.get(parent.available_tags, name="‚úÖ Solved")
        unsolved_tag = discord.utils.get(parent.available_tags, name="‚ùå Unsolved")

        tags = [tag for tag in thread.applied_tags if tag.name != "‚ùå Unsolved"]
        if solved_tag and solved_tag not in tags:
            tags.append(solved_tag)

        new_name = thread.name
        if not new_name.startswith("‚úÖ "):
            new_name = f"‚úÖ {new_name.lstrip('‚ùå ').strip()}"
            await thread.edit(applied_tags=tags, name=new_name)
        else:
            await thread.edit(applied_tags=tags)

        await interaction.response.send_message(
                                        """``` 

                ‚ñë‚ñà‚îÄ‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñÄ ‚ñà ‚ñà‚ñÄ‚ñÄ „ÄÄ ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚ñà ‚îÄ‚ñÄ‚îÄ ‚ñà‚ñÄ‚ñÄ‚ñÑ ‚ñà‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñà‚ñÄ‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñà 
                ‚ñë‚ñà‚îÄ‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÄ ‚îÄ‚îÄ‚ñà‚îÄ‚îÄ ‚îÄ ‚ñÄ‚ñÄ‚ñà „ÄÄ ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÑ ‚ñÄ‚ñà‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚îÄ‚ñÄ‚ñà „ÄÄ ‚ñà‚îÄ‚ñÄ‚ñà ‚ñà‚îÄ‚îÄ‚ñà 
                ‚ñë‚ñà‚ñÑ‚ñÑ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚îÄ‚îÄ‚ñÄ‚îÄ‚îÄ ‚îÄ ‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñÄ‚îÄ‚îÄ ‚îÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚îÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚îÄ‚îÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ
                ```"""
            f"{spycat_good} üéâ SpyCat bondit sur sa chaise, claque sa patte et marque ce thread comme **R√âSOLU** : `{new_name}`.\n"
            f"üïµÔ∏è‚Äç‚¨õ *Prochaine traque ? SpyCat est pr√™t, ses moustaches fr√©tillent d‚Äôexcitation.*",
            ephemeral=False
        )

    else:
        if not thread.name.startswith("‚úÖ "):
            new_name = f"‚úÖ {thread.name.lstrip('‚ùå ').strip()}"
            await thread.edit(name=new_name)
            await interaction.response.send_message(
                            """``` 

                ‚ñë‚ñà‚îÄ‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñà‚ñÄ‚ñÄ ‚ñà ‚ñà‚ñÄ‚ñÄ „ÄÄ ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚ñà ‚îÄ‚ñÄ‚îÄ ‚ñà‚ñÄ‚ñÄ‚ñÑ ‚ñà‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñà‚ñÄ‚ñÄ‚ñÄ ‚ñà‚ñÄ‚ñÄ‚ñà 
                ‚ñë‚ñà‚îÄ‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÄ ‚îÄ‚îÄ‚ñà‚îÄ‚îÄ ‚îÄ ‚ñÄ‚ñÄ‚ñà „ÄÄ ‚ñà‚ñÄ‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚îÄ‚îÄ ‚ñà‚ñÄ‚ñÑ ‚ñÄ‚ñà‚ñÄ ‚ñà‚îÄ‚îÄ‚ñà ‚ñà‚îÄ‚ñÄ‚ñà „ÄÄ ‚ñà‚îÄ‚ñÄ‚ñà ‚ñà‚îÄ‚îÄ‚ñà 
                ‚ñë‚ñà‚ñÑ‚ñÑ‚ñà ‚ñÄ‚ñÄ‚ñÄ ‚îÄ‚îÄ‚ñÄ‚îÄ‚îÄ ‚îÄ ‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñÄ‚îÄ‚îÄ ‚îÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚îÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚îÄ‚îÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ „ÄÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ ‚ñÄ‚ñÄ‚ñÄ‚ñÄ
                ```"""
                f"{spycat_good} üéâ SpyCat crie victoire et note : Challenge **R√âSOLU** ‚Üí `{new_name}`.\n"
                f"ü•≥ *Une mission de plus, un myst√®re de moins.*",
                ephemeral=False
            )
        else:
            await interaction.response.send_message(
                f"{spycat_stop} SpyCat grogne : ce challenge est d√©j√† **R√âSOLU** !",
                ephemeral=True
            )


@bot.tree.command(name="enfintabarnak", description="Marque ce challenge comme r√©solu et renomme le thread.")
async def enfintabarnak(interaction: discord.Interaction):
    thread = interaction.channel

    if not isinstance(thread, discord.Thread):
        await interaction.response.send_message(
            f"{spycat_stop} T‚Äôes pas dans un thread, agent ! SpyCat ne veut pas voir √ßa ailleurs.",
            ephemeral=True
        )
        return

    parent = thread.parent

    if isinstance(parent, discord.ForumChannel):
        solved_tag = discord.utils.get(parent.available_tags, name="‚úÖ Solved")
        unsolved_tag = discord.utils.get(parent.available_tags, name="‚ùå Unsolved")

        tags = [tag for tag in thread.applied_tags if tag.name != "‚ùå Unsolved"]
        if solved_tag and solved_tag not in tags:
            tags.append(solved_tag)

        new_name = thread.name
        if not new_name.startswith("‚úÖ "):
            new_name = f"‚úÖ {new_name.lstrip('‚ùå ').strip()}"
            await thread.edit(applied_tags=tags, name=new_name)
        else:
            await thread.edit(applied_tags=tags)

        await interaction.response.send_message(
            """``` 
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó
            ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïî‚ïù
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïê‚ïù‚ñë
            ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó‚ñë
            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ïó
            ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù
            ```"""
            f"{spycat_good} SpyCat bondit sur ton clavier, pousse un *miaulement de victoire* et raye ce d√©fi de sa liste noire : `{new_name}`.\n"
            f"üêæ *Une ride de plus, une griffe de moins ‚Äî mais la chasse continue.*",
            ephemeral=False
        )

    else:
        if not thread.name.startswith("‚úÖ "):
            new_name = f"‚úÖ {thread.name.lstrip('‚ùå ').strip()}"
            await thread.edit(name=new_name)
            await interaction.response.send_message(
                """``` 
                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó
                ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïî‚ïù
                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïê‚ïù‚ñë
                ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó‚ñë
                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ïó
                ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù
                ```"""
                f"{spycat_good} üéâ SpyCat d√©chire le dernier indice et hurle : *Mission accomplie.* `{new_name}` est **R√âSOLU**.\n"
                f"‚ú® *Va prendre tes croquettes, tu l‚Äôas m√©rit√©.*",
                ephemeral=False
            )
        else:
            await interaction.response.send_message(
                f"{spycat_stop} Trop tard agent : ce challenge est d√©j√† **R√âSOLU** ‚Äî SpyCat ricane dans l‚Äôombre.",
                ephemeral=True
            )


## UNSOLVED
@bot.tree.command(name="unsolved", description="Marque ce challenge comme non r√©solu (Forum ou Thread).")
async def unsolved(interaction: discord.Interaction):
    thread = interaction.channel

    if not isinstance(thread, discord.Thread):
        await interaction.response.send_message(
            f"{spycat_stop} Cette commande doit √™tre utilis√©e dans un **thread**, espion !",
            ephemeral=True
        )
        return

    parent = thread.parent

    if isinstance(parent, discord.ForumChannel):
        solved_tag = discord.utils.get(parent.available_tags, name="‚úÖ Solved")
        unsolved_tag = discord.utils.get(parent.available_tags, name="‚ùå Unsolved")

        tags = [tag for tag in thread.applied_tags if tag.name != "‚úÖ Solved"]

        if unsolved_tag and unsolved_tag not in tags:
            tags.append(unsolved_tag)

        clean_name = thread.name.lstrip('‚úÖ‚ùå ').strip()

        await thread.edit(applied_tags=tags, name=clean_name)
        await interaction.response.send_message(
            f"{spycat_X} Le challenge est maintenant marqu√© comme **Non R√©solu** (Forum) : `{clean_name}`.\n"
            f"üêæ SpyCat garde un ≈ìil... R√©essaye de le griffer !",
            ephemeral=False
        )

    else:
        clean_name = thread.name.lstrip('‚úÖ‚ùå ').strip()

        await thread.edit(name=clean_name)
        await interaction.response.send_message(
            f"{spycat_X} Le challenge est maintenant marqu√© comme **Non R√©solu** : `{clean_name}`.\n"
            f"{spycat_hint} *SpyCat t‚Äôobserve, pr√™t pour un nouvel assaut.*",
            ephemeral=False
        )


## CHALLENGES LIST
@bot.tree.command(name="challenges", description="Affiche la liste des challenges disponibles (Planque Only).")
async def challenges(interaction: discord.Interaction):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()
    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name != channel_name:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")
        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"{spycat_hint} Utilise `/challenges` **dans ta planque** : {planque.mention} {spycat_stop}"
        )
        await interaction.response.send_message(
            f"{spycat_stop} Seuls les agents tapis dans leur planque peuvent consulter la liste : {planque.mention}",
            ephemeral=True
        )
        return

    msg = f"""
**{spycat_hint} Dossier Classifi√© : Challenges Disponibles**

Voici ta liste, petit espion üëÄ :
{spycat_hint}

 `/first_claw` : La premi√®re trace laiss√©e par SpyCat. D√©bute ta traque.
 `/spycat_hideout` : Tente de forcer la tani√®re secr√®te de SpyCat.
 `/terminal` : Fouille le terminal HoneyPaw pour trouver des fichiers suspects.
 `/last_paw` : La derni√®re trace... mais SpyCat a 8 vies. Jusqu'o√π iras-tu ?
 `/hint challenge:<nom>` : Tente la roulette russe pour un indice... si tu oses.

**{spycat_X} Tous ces challenges ne fonctionnent que dans ta planque secr√®te !**
Si tu agis hors de l‚Äôombre, SpyCat d√©vore tes espoirs.

Bonne traque, agent. Et surveille tes moustaches. {spycat_hint}
"""
    await interaction.response.send_message(msg)




## Hint Command
@bot.tree.command(name="hint", description="Tente ta chance pour un hint de SpyCat (Planque Only).")
@app_commands.describe(challenge="Nom du challenge pour le hint.")
async def hint(interaction: discord.Interaction, challenge: str):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()

    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name != channel_name:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")
        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"{spycat_hint} Essaie `/hint challenge:{challenge}` ici pour obtenir ton indice ! {spycat_stop}"
        )
        await interaction.response.send_message(
            f"{spycat_stop} Va dans ta planque pour demander un hint : {planque.mention}",
            ephemeral=True
        )
        return
    
    HINTS = {
        "first_claw": [
            f"{spycat_roulette_hit} SpyCat murmure : *Regarde bien ces symboles... Un langage bien connu des pirates du Net.*",
            f"{spycat_roulette_hit} SpyCat s‚Äô√©tire : *D√©coder n‚Äôest que le d√©but. Soumettre est une autre histoire.*",
            f"{spycat_roulette_hit} SpyCat griffe : *Le flag est d√©j√† sous ton nez. Sais-tu seulement le lire ?*",
            f"{spycat_roulette_miss} SpyCat se gratte l‚Äôoreille. Aucun indice pour toi aujourd‚Äôhui.",
            f"{spycat_roulette_miss} Un miaulement sarcastique r√©sonne. Reviens plus tard."
        ],
        "spycat_hideout": [
            f"{spycat_roulette_hit} SpyCat glisse : *L‚Äôadresse n‚Äôest jamais ce qu‚Äôelle para√Æt √™tre.*",
            f"{spycat_roulette_hit} SpyCat ronronne : *64 fa√ßons de cacher un secret...* ",
            f"{spycat_roulette_hit} SpyCat feule : *Des chiffres qui veulent devenir des lettres...* ",
            f"{spycat_roulette_hit} SpyCat ricane : *Un d√©calage bien plac√© peut renverser un empire.*",
            
            f"{spycat_roulette_miss} SpyCat baille. Rien pour toi aujourd'hui.",
            f"{spycat_roulette_miss} Mauvais jeton. Essaie encore, petit curieux.",
            f"{spycat_roulette_miss} Mes moustaches fr√©missent : pas d‚Äôindice pour toi.",
            f"{spycat_roulette_miss} Trop curieux ? Reviens quand tu sauras vraiment griffer."
        ],
        "terminal": [
            f"{spycat_hint} SpyCat ricane : *Toutes les pattes m√®nent au Honeypaw... mais certaines griffures cachent mieux que d‚Äôautres.*",
            f"{spycat_hint} SpyCat feule : *Ne t‚Äôarr√™te pas au premier fichier. Pousse tes griffes plus loin...*",
            f"{spycat_hint} SpyCat ronronne : *Un r√©pertoire peut cacher un autre. Creuse.*",
            f"{spycat_roulette_miss} Tes pattes sont trop molles pour m√©riter un indice.",
            f"{spycat_roulette_miss} SpyCat ferme ses yeux. Pas aujourd‚Äôhui."
        ],
        "last_paw": [
            f"{spycat_roulette_hit} SpyCat griffe : *Les m√©tadonn√©es murmurent des secrets que tes yeux n‚Äôont jamais lus...* ",
            f"{spycat_roulette_hit} SpyCat ronronne : *Un simple fichier peut cacher une tani√®re plus profonde qu‚Äôil n‚Äôy para√Æt...* ",
            f"{spycat_roulette_hit} SpyCat ricane : *Fouille jusqu‚Äô√† la moelle. M√™me ce que tu crois inutile peut miauler un indice.* ",
            f"{spycat_roulette_hit} SpyCat feule : *Croise tes griffes : commentaires, cachettes, cha√Ænes perdues... parfois tout se rejoint.*",
            f"{spycat_roulette_miss} SpyCat baille : *Pas d‚Äôindice. Cherche encore, petit curieux.*",
            f"{spycat_roulette_miss} SpyCat l√®ve la queue : *Un miaulement moqueur. Tu n‚Äôas rien aujourd‚Äôhui.*",
            f"{spycat_roulette_miss} SpyCat ferme ses yeux : *Reviens quand tes pattes seront plus affut√©es.*",
            f"{spycat_roulette_miss} SpyCat s‚Äôenfuit dans l‚Äôombre : *Pas d‚Äôindice. Pour l‚Äôinstant.*"
        ]
    }

    if challenge not in HINTS:
        await interaction.response.send_message(
            f"{spycat_X} Aucun hint pour ce challenge : `{challenge}`",
            ephemeral=True
        )
        return

    chosen = random.choice(HINTS[challenge])
    await interaction.response.send_message(
        f"{spycat_roulette} Roulette russe de SpyCat pour **{challenge}** :\n{chosen} {spycat_roulette}"
    )

## Challenge de d√©part
@bot.tree.command(name="first_claw", description="Pose ta premi√®re griffe sur le flag de d√©part (Planque Only).")
async def first_claw(interaction: discord.Interaction):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()
    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name != channel_name:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")
        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"{spycat_stop} Essaie `/challenge` ici pour commencer ta traque : {planque.mention} {spycat_stop}"
        )
        await interaction.response.send_message(
            f"{spycat_stop} Commande r√©serv√©e √† ta planque : {planque.mention}",
            ephemeral=True
        )
        return

    base64_flag = "Q1NJVUx7U3B5Q2F0X2lzX3dhdGNoaW5nX3lvdX0="
    msg = (
        """``` 

   ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñÑ‚ñà     ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà           ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñÑ‚ñà          ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñÑ‚ñà     ‚ñà‚ñÑ  
  ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ      ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà 
  ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ  ‚ñà‚ñà‚ñà‚ñå   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ     ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñà      ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ  ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà 
 ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ     ‚ñà‚ñà‚ñà‚ñå  ‚ñÑ‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñÄ   ‚ñà‚ñà‚ñà            ‚ñà‚ñà‚ñà   ‚ñÄ      ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà 
‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñÄ‚ñÄ     ‚ñà‚ñà‚ñà‚ñå ‚ñÄ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñÄ‚ñÄ‚ñÄ‚ñÄ   ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà       ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà 
  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà  ‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà    ‚ñà‚ñÑ  ‚ñà‚ñà‚ñà         ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà 
  ‚ñà‚ñà‚ñà        ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà    ‚ñÑ‚ñà    ‚ñà‚ñà‚ñà     ‚ñà‚ñà‚ñà          ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñå    ‚ñÑ   ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñÑ‚ñà‚ñÑ ‚ñà‚ñà‚ñà 
  ‚ñà‚ñà‚ñà        ‚ñà‚ñÄ     ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ     ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñÄ        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÄ  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñÑ‚ñà‚ñà   ‚ñà‚ñà‚ñà    ‚ñà‚ñÄ   ‚ñÄ‚ñà‚ñà‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñÄ  
                    ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà                                          ‚ñÄ                                  

        ```"""
        f"**{spycat_hint} Chasse au Chat : Premi√®re Griffe {spycat_hint}**\n"
        f"Miaou~ Agent {user.name}, tu crois vraiment pouvoir effleurer ma patte ?\n"
        f"SpyCat t‚Äôobserve derri√®re chaque ligne de code‚Ä¶ Et ce n‚Äôest que le d√©but.\n\n"
        f"üîë **Cl√© crypt√©e** : `{base64_flag}`\n"
        f"D√©code, gratte, et reviens miauler.\n"
        f"Bonne traque, petit humain‚Ä¶ et n‚Äôoublie pas : SpyCat n‚Äôest jamais loin. {random_cat()}\n\n"
    )
    await interaction.response.send_message(msg)

## SpyCat Hideout Challenge
@bot.tree.command(name="spycat_hideout", description="Tente de d√©couvrir la planque secr√®te de SpyCat.")
async def spycat_hideout(interaction: discord.Interaction):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()
    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name != channel_name:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")
        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"{spycat_stop} Commande `/spycat_hideout` r√©serv√©e √† ta planque ! Essaie ici : {planque.mention} {spycat_stop}"
        )
        await interaction.response.send_message(
            f"{spycat_stop} Pas ici ! Va dans ta planque : {planque.mention}",
            ephemeral=True
        )
        return

    lore_msg =f"""
{spycat_hint} **Dossier Classifi√© : SpyCat Hideout**

*Bienvenue, espion {user.name}‚Ä¶*

Tu te tiens √† la porte de ma tani√®re.  
SpyCat n‚Äôouvre qu‚Äô√† ceux qui savent lire entre les griffures.

Ce que je cache n‚Äôest pas prot√©g√© par un simple cadenas :  
ici, chaque couche est une ruse, chaque caract√®re un pi√®ge.

Certains se perdent dans des encodages futiles,  
d‚Äôautres croient qu‚Äôun simple coup de patte suffira.  
**Ils ont tous √©chou√©.**

Rappelle-toi :  
> *Celui qui me trouve n‚Äôa plus rien √† prouver √† personne.*

Quand tu croiras √™tre digne, apporte-moi ta preuve :

NDYgNTYgNGMgNTggNGYgN2IgNzcgNmIgNjggNWYgNzcgNzUgNzggNjggNWYgNmIgNmMgNjcgNjggNzIgNzggNzcgNWYgNzIgNjkgNWYgNzYgNzMgNjIgNjYgNjQgNzcgNWYgNmMgNzYgNWYgNzIgNzEgNmYgNjIgNWYgNjkgNzIgNzUgNWYgNzcgNmIgNjggNWYgNzYgNmIgNjQgNzUgNzMgNjggNzYgNzcgNWYgNjQgNmEgNjggNzEgNzcgNzYgN2Q%3D

{spycat_roulette} *Si ta patte tremble,* murmure `/hint challenge:spycat_hideout`  
‚Ä¶ mais sache que ma roulette n‚Äôa pas de piti√© pour les faibles.

{spycat_hint}
"""
    await interaction.response.send_message(lore_msg)



## SpyCat Terminal Challenge 
@bot.tree.command(name="terminal", description="Simule un terminal Linux pi√©g√© par SpyCat.")
@app_commands.describe(cmd="Commande √† ex√©cuter (ls, pwd, cat <file>, ls ..)")
async def terminal(interaction: discord.Interaction, cmd: str):
    guild = interaction.guild
    user = interaction.user
    channel_name = f"planque-{user.name}".lower()
    planque = discord.utils.get(guild.text_channels, name=channel_name)

    if interaction.channel.name != channel_name:
        overwrites = {
            guild.default_role: discord.PermissionOverwrite(read_messages=False),
            user: discord.PermissionOverwrite(read_messages=True, send_messages=True),
            guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True)
        }
        category = discord.utils.get(guild.categories, name="Planques")
        if planque is None:
            planque = await guild.create_text_channel(
                channel_name, overwrites=overwrites, category=category
            )

        await planque.send(
            f"{spycat_stop} SpyCat a ouvert un terminal‚Ä¶ mais uniquement dans ta planque : {planque.mention} {spycat_stop}"
        )
        await interaction.response.send_message(
            f"{spycat_stop} Utilise `/terminal` seulement dans ta planque : {planque.mention}",
            ephemeral=True
        )
        return

    cmd = cmd.strip().lower()
    output = ""

    if cmd == "pwd":
        output = "/secret_hideout/HoneyPaw"
    elif cmd == "ls":
        output = "flag.txt spycat_is_watching_you.txt"
    elif cmd.startswith("cat "):
        file = cmd.split(" ", 1)[1]
        if file == "flag.txt":
            output = (
                f"üòπ Bien tent√©, espion en carton ! "
                f"Ce flag est plus vide qu‚Äôun bol de croquettes √† 3h du matin.\n"
                f"*R√©fl√©chis, ou SpyCat te regardera √©chouer encore.*"
            )
        elif file == "spycat_is_watching_you.txt":
            output = (
                """
                ‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
                ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ÄÉ‚ÄÉ‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
                ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ÄÉ‚ÄÉ‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ÄÉ‚ÄÉ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë
                ‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ñà‚ñà‚ïë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë
                ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ÄÉ‚ÄÉ‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
                ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ÄÉ‚ÄÉ‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ÄÉ‚ÄÉ‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

                """
            )
        elif file == "../secret_flag.txt":
            output = "CSIUL{SpyCat_Loves_HoneyPaws}"
        else:
            output = f"cat: {file}: Aucun fichier ou dossier de ce type"
    elif cmd == "ls ..":
        output = "secret_flag.txt"
    else:
        output = f" Commande inconnue : `{cmd}`. SpyCat ricane dans l‚Äôombre."

    await interaction.response.send_message(
        f"```bash\n$ {cmd}\n{output}\n```"
    )

@bot.tree.command(name="last_paw", description="Commence ta traque avec la premi√®re empreinte de SpyCat.")
async def last_paw(interaction: discord.Interaction):
    user = interaction.user.name

    msg =f"""
**{spycat_hint} Dossier Ultra-Confidentiel : Premi√®re Griffe de SpyCat {spycat_hint}**

üêæ *Agent {user}, tu as os√© poser ta patte sur ma trace...*

> *Regarde au-del√† des pixels...*  
> *Lis entre les griffures EXIF...*

Dans chaque octet, je laisse une empreinte :  
- üóÇÔ∏è Un champ de **commentaire** peut devenir un tunnel.
- üß© Un mot-cl√© peut devenir une cl√©.

Quand tu d√©chiffreras ce que je cache,  
rapporte-le **dans ta planque**... et seulement l√†.

Miaou~ Espion. üïµÔ∏è‚Äç‚¨õ {random_cat()}
"""
    file = discord.File("SpyCatIsWatchingYou.jpg", filename="SpyCatIsWatchingYou.jpg")
    await interaction.response.send_message(msg, file=file)



# RUN 

bot.run(DISCORD_TOKEN)
